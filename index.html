<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>POWERCON - Nutriveb</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    .font-mono-numbers { font-family: ui-monospace, monospace; font-variant-numeric: tabular-nums; }
    body { 
      background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('./assets/bg.jpg');
      background-size: cover; background-position: center; background-attachment: fixed;
    }
    input[type="date"] { display: block; -webkit-appearance: none; min-height: 4rem; width: 100%; }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 0.75rem; }
    .modal-content { background: white; border-radius: 2rem; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .btn-touch:active { transform: scale(0.96); opacity: 0.9; }
    input:disabled { color: #94a3b8; background-color: #f1f5f9; cursor: not-allowed; opacity: 1; -webkit-text-fill-color: #64748b; }
    .progress-fill { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
  </style>
</head>
<body class="h-full text-slate-900 overflow-x-hidden">
  <div id="app" class="h-full w-full"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCwtWs9YdZMojl1FwQNXbAF-QRhWCrlWMQ",
      authDomain: "powercon-nutriveb.firebaseapp.com",
      projectId: "powercon-nutriveb",
      storageBucket: "powercon-nutriveb.firebasestorage.app",
      messagingSenderId: "780606101460",
      appId: "1:780606101460:web:ce9b6c7b73bb756a5a6841",
      databaseURL: "https://powercon-nutriveb-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MOCK_EQUIPMENT = [
      { id: '1', name: 'Refrigeration System', loc: 'UTILITIES' }, { id: '2', name: 'Clean Steam Generator', loc: 'UTILITIES' }, { id: '3', name: 'Bulk Chemical System', loc: 'UTILITIES' }, { id: '4', name: 'Condensate Return System', loc: 'UTILITIES' }, { id: '5', name: 'RVAC', loc: 'UTILITIES' }, { id: '6', name: 'BOILER', loc: 'UTILITIES' }, { id: '7', name: 'Compressed Dry Air (CDA)', loc: 'UTILITIES' }, { id: '8', name: 'Waste Water Treatment Plant (WWTP)', loc: 'UTILITIES' }, { id: '9', name: 'Water Treatment Plant (WTP)', loc: 'UTILITIES' }, { id: '10', name: 'Combined Water Storage (CWS)', loc: 'UTILITIES' }, { id: '11', name: 'Sump Pit Pump 1', loc: 'UTILITIES' }, { id: '12', name: 'Freezer & Cold Storage', loc: 'UTILITIES' }, { id: '13', name: 'CIP Line (E7)', loc: 'PROCESS' }, { id: '14', name: 'Bottle Washer (E8)', loc: 'PROCESS' }, { id: '15', name: 'Modular Labeller (E9)', loc: 'PROCESS' }, { id: '16', name: 'Container Conveyor (E10)', loc: 'PROCESS' }, { id: '17', name: 'Conveyor Lubrication (E11)', loc: 'PROCESS' }, { id: '18', name: 'Alwin Soy', loc: 'PROCESS' }, { id: '19', name: 'Process MCC', loc: 'PROCESS' }, { id: '20', name: 'Homogenizer', loc: 'PROCESS' }, { id: '21', name: 'Soya Bean Pre-treatment & Handling', loc: 'PROCESS' }, { id: '22', name: 'Sugar Dissolving', loc: 'PROCESS' }, { id: '23', name: 'Container Dryer (E1)', loc: 'BOTTLING' }, { id: '24', name: 'Packer (E2)', loc: 'BOTTLING' }, { id: '25', name: 'Unpacker (E3)', loc: 'BOTTLING' }, { id: '26', name: 'Container Depalettiser (E4)', loc: 'BOTTLING' }, { id: '27', name: 'Pack Washing (E5)', loc: 'BOTTLING' }, { id: '28', name: 'Inspector (E6)', loc: 'BOTTLING' }, { id: '29', name: 'Pack Conveyor (E12)', loc: 'BOTTLING' }, { id: '30', name: 'Ups', loc: 'BOTTLING' }, { id: '31', name: 'Wrap Round', loc: 'BOTTLING' }, { id: '32', name: 'Hydro Sterilizer', loc: 'BOTTLING' }, { id: '33', name: 'Filler', loc: 'BOTTLING' }, { id: '34', name: 'DPP', loc: 'LVSG 5 LOADS' }, { id: '35', name: 'DLP', loc: 'LVSG 5 LOADS' }, { id: '36', name: 'WareHouse', loc: 'LVSG 5 LOADS' }, { id: '37', name: 'RVAC (220V)', loc: 'LVSG 5 LOADS' }, { id: '38', name: 'WWTP (220V)', loc: 'LVSG 5 LOADS' }, { id: '39', name: 'DP-WM', loc: 'LVSG 5 LOADS' }, { id: '40', name: 'Sumppit Pump2', loc: 'LVSG 5 LOADS' }, { id: '41', name: 'Accumulation Table', loc: 'LVSG 5 LOADS' }
    ];

    const fmt = (num) => (num || 0).toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 });

    const getLocalDate = (d) => {
      const offset = d.getTimezoneOffset();
      const localDate = new Date(d.getTime() - (offset * 60 * 1000));
      return localDate.toISOString().split('T')[0];
    };

    class PowerCon {
      constructor() {
        const today = new Date();
        this.state = {
          view: 'home', currentIndex: 0,
          date: getLocalDate(today),
          filterDate: getLocalDate(today),
          sessionReadings: [],
          cloudReadings: {},
          yesterdayReadings: {},
          loading: false,
          isSingleEdit: false 
        };
        this.init();
      }
        placeholderAction(type) {
        alert(`üöÄ FEATURE PREVIEW:\n\nThis will generate the ${type} using the Nutriveb Official Template.\n\nStatus: Pending management approval for digital logsheet format.`);
      }

      async init() { this.render(); await this.syncWithCloud(); }

      async syncWithCloud() {
        this.state.loading = true; this.render();
        const snapshot = await db.ref('readings/' + this.state.date).once('value');
        this.state.cloudReadings = snapshot.val() || {};
        const d = new Date(this.state.date);
        d.setDate(d.getDate() - 1);
        const yKey = getLocalDate(d);
        const ySnap = await db.ref('readings/' + yKey).once('value');
        this.state.yesterdayReadings = ySnap.val() || {};
        
        MOCK_EQUIPMENT.forEach((eq, i) => {
            if(this.state.cloudReadings[eq.id]) this.state.sessionReadings[i] = this.state.cloudReadings[eq.id];
        });
        this.state.loading = false; this.render();
      }

      async start() { 
        await this.syncWithCloud();
        this.state.isSingleEdit = false;
        let firstEmpty = 0;
        for(let i=0; i<MOCK_EQUIPMENT.length; i++) {
          if(!this.state.cloudReadings[MOCK_EQUIPMENT[i].id]) { firstEmpty = i; break; }
        }
        this.state.currentIndex = firstEmpty;
        this.state.view = 'reading'; 
        this.render(); 
      }

      async saveReading(curr, prevInput) {
        const eq = MOCK_EQUIPMENT[this.state.currentIndex];
        const current = parseFloat(parseFloat(curr).toFixed(3));
        let prev = parseFloat(parseFloat(prevInput || 0).toFixed(3));
        const usage = parseFloat((current - prev).toFixed(3));
        
        if (current < prev && !confirm("‚ö†Ô∏è ABNORMAL: Current is lower than Previous. Continue?")) return;
        
        const data = { id: eq.id, name: eq.name, loc: eq.loc, curr: current, prev: prev, usage: usage };
        this.state.sessionReadings[this.state.currentIndex] = data;

        if (this.state.isSingleEdit) {
          this.state.loading = true; this.render();
          await db.ref(`readings/${this.state.date}/${eq.id}`).set(data);
          this.state.isSingleEdit = false;
          this.state.view = 'records';
          await this.syncWithCloud();
        } else {
          if (this.state.currentIndex < 40) { this.state.currentIndex++; this.render(); } 
          else { this.state.view = 'review'; this.render(); }
        }
      }

      render() { document.getElementById('app').innerHTML = this[`${this.state.view}HTML`](); }

      homeHTML() {
        return `<div class="p-6 max-w-sm mx-auto flex flex-col justify-center min-h-screen text-center">
          <h1 class="text-6xl font-black text-slate-900 italic tracking-tighter mb-2">POWER<span class="text-blue-600">CON</span></h1>
          <p class="text-slate-400 font-bold text-[10px] tracking-[0.4em] mb-12 uppercase italic text-blue-500 font-black">CALCULATOR</p>
          <div class="flex flex-col gap-4 w-full">
            <div class="w-full">
               <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block text-center tracking-widest">Reading Date</label>
               <input type="date" value="${this.state.date}" class="w-full px-5 py-4 bg-white rounded-3xl border-2 border-slate-100 shadow-sm font-bold text-lg outline-none text-center" onchange="app.state.date=this.value; app.syncWithCloud()">
            </div>
            <button onclick="app.start()" class="btn-touch w-full bg-blue-600 text-white font-black py-6 rounded-3xl shadow-xl text-xl uppercase italic">Start Reading</button>
            <button onclick="app.state.view='records';app.render()" class="btn-touch w-full bg-slate-900 text-white font-bold py-5 rounded-3xl uppercase tracking-widest text-sm text-blue-400 italic font-black underline underline-offset-4 ">View Dashboard</button>
          </div>
          ${this.state.loading ? '<p class="mt-4 text-[10px] font-black animate-pulse text-blue-600 uppercase tracking-widest">Verifying Cloud...</p>' : ''}
        </div>`;
      }

      readingHTML() {
        const total = MOCK_EQUIPMENT.length;
        const progress = ((this.state.currentIndex + 1) / total) * 100;
        const eq = MOCK_EQUIPMENT[this.state.currentIndex];
        const cloudData = this.state.cloudReadings[eq.id];
        
        let autoPrev = '0.000';
        const yData = this.state.yesterdayReadings ? this.state.yesterdayReadings[eq.id] : null;
        autoPrev = yData ? yData.curr : '0.000';

        const isPrevLocked = !this.state.isSingleEdit;
        let currentVal = '';
        if (this.state.isSingleEdit && cloudData) {
            currentVal = cloudData.curr;
            autoPrev = cloudData.prev;
        }

        return `<div class="modal"><div class="modal-content p-8 shadow-2xl relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-2 bg-slate-100">
            <div class="h-full bg-blue-600 progress-fill" style="width: ${progress}%"></div>
          </div>

          <div class="flex justify-between items-center mb-6 mt-4">
            <span class="text-[10px] font-black bg-blue-600 text-white px-3 py-1 rounded-full uppercase italic">${eq.loc}</span>
            <span class="text-xs font-black text-blue-600 font-mono-numbers">${this.state.currentIndex+1} / ${total}</span>
          </div>
          
          <h2 class="text-2xl font-black leading-tight mb-8">${eq.name}</h2>
          
          <form onsubmit="event.preventDefault(); app.saveReading(document.getElementById('c').value, document.getElementById('p').value)">
            <div class="mb-4 p-4 ${isPrevLocked ? 'bg-slate-50' : 'bg-blue-50 border-blue-200 border-2'} rounded-2xl border text-left">
              <label class="text-[8px] font-black text-slate-400 uppercase tracking-widest italic flex justify-between mb-1">
                Previous Reading ${isPrevLocked ? 'üîí' : 'üîì'}
              </label>
              <input type="number" id="p" step="0.001" class="w-full bg-transparent text-xl font-bold outline-none" 
                value="${autoPrev}" ${isPrevLocked ? 'disabled' : ''}>
            </div>

            <div class="mb-10 text-left">
              <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest text-center">Current Reading</label>
              <input type="number" id="c" step="0.001" class="w-full p-6 bg-slate-100 rounded-3xl text-4xl font-black outline-none font-mono-numbers shadow-inner text-center text-blue-600" 
                value="${currentVal}" placeholder="0.000" required autofocus>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <button type="button" onclick="app.exitReading()" class="py-5 font-bold text-slate-400 uppercase text-xs">Exit</button>
              <button type="submit" class="bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl uppercase">${this.state.isSingleEdit ? 'Update' : 'Save & Next'}</button>
            </div>
          </form>
        </div></div>`;
      }

      exitReading() {
        if (this.state.isSingleEdit) { this.state.view = 'records'; this.state.isSingleEdit = false; }
        else { this.state.view = 'home'; }
        this.render();
      }

      reviewHTML() {
        return `<div class="p-6 max-w-2xl mx-auto flex flex-col min-h-screen">
          <h2 class="text-4xl font-black mb-6 italic pt-10 uppercase tracking-tighter">Review Logs</h2>
          <div class="bg-white rounded-[2.5rem] shadow-xl border overflow-hidden flex-1 mb-6 overflow-y-auto">
             <table class="w-full text-xs">
               <tbody class="divide-y divide-slate-100">
                 ${this.state.sessionReadings.map((r, i) => r ? `
                   <tr onclick="app.editFromReview(${i})" class="active:bg-blue-50">
                     <td class="p-4 font-black text-slate-800 uppercase text-[9px] leading-tight">${r.name}</td>
                     <td class="p-4 text-right font-mono-numbers font-black text-blue-600">${fmt(r.curr)}</td>
                   </tr>` : '').join('')}
               </tbody>
             </table>
          </div>
          <button onclick="app.finalCloudSave()" class="btn-touch w-full bg-green-600 text-white font-black py-7 rounded-3xl shadow-2xl text-xl uppercase italic mb-10 tracking-widest">Sync Final Data ‚úì</button>
        </div>`;
      }

      async finalCloudSave() {
        this.state.loading = true; this.render();
        const updates = {};
        this.state.sessionReadings.forEach(r => { if(r) updates[`/readings/${this.state.date}/${r.id}`] = r; });
        try {
          await db.ref().update(updates);
          alert("‚úÖ Records Saved Successfully!");
          this.state.view = 'records';
          this.state.filterDate = this.state.date;
          await this.syncWithCloud();
        } catch (e) { alert("Error: " + e.message); }
        this.state.loading = false; this.render();
      }

      recordsHTML() {
        const cats = ["UTILITIES", "PROCESS", "BOTTLING", "LVSG 5 LOADS"];
        const data = Object.values(this.state.cloudReadings);
        const total = data.reduce((s, r) => s + (r.usage || 0), 0);
        
        return `<div class="p-4 max-w-2xl mx-auto min-h-screen pb-32">
          <div class="flex justify-between items-center mb-4 pt-4">
            <button onclick="app.state.view='home';app.render()" class="font-black text-slate-400 text-xs tracking-widest underline decoration-blue-500">‚Üê HOME</button>
            <input type="date" value="${this.state.filterDate}" onchange="app.state.filterDate=this.value; app.syncWithCloud()" class="bg-white px-3 py-1 rounded-xl border-2 border-blue-100 font-bold text-xs shadow-sm">
          </div>

          <div class="bg-white/90 backdrop-blur p-6 rounded-[2rem] shadow-xl border border-white mb-6 text-center">
            <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 italic">Daily Total Consumption</h3>
            <div class="text-4xl font-black text-slate-900 font-mono-numbers">${fmt(total)} <span class="text-sm text-blue-500">kWh</span></div>
          </div>

          <div class="space-y-6 mb-12">
            ${cats.map(cat => `
              <div>
                <div class="px-4 mb-2 text-[10px] font-black text-slate-500 uppercase tracking-widest">${cat}</div>
                <div class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-200 overflow-hidden divide-y">
                  ${MOCK_EQUIPMENT.filter(e => e.loc === cat).map(e => {
                    const r = this.state.cloudReadings[e.id] || { prev: 0, curr: 0, usage: 0 };
                    return `
                    <div class="p-5 active:bg-blue-50" onclick="app.editFromDashboard('${e.id}')">
                      <div class="text-[11px] font-black text-slate-800 uppercase mb-3 flex justify-between">${e.name} <span class="text-[8px] text-blue-400 italic underline font-black">Admin Edit üîí</span></div>
                      <div class="grid grid-cols-3 gap-2">
                        <div class="text-center bg-white border p-2 rounded-xl"><div class="text-[7px] font-bold text-slate-400">PREV (12:00am)</div><div class="text-[10px] font-mono-numbers">${fmt(r.prev)}</div></div>
                        <div class="text-center bg-white border p-2 rounded-xl"><div class="text-[7px] font-bold text-blue-500 font-black italic">CURR (12:00am)</div><div class="text-[10px] font-mono-numbers font-black">${fmt(r.curr)}</div></div>
                        <div class="text-center bg-blue-600 p-2 rounded-xl"><div class="text-[7px] font-black text-blue-100">TOTAL kWh</div><div class="text-[10px] font-mono-numbers font-black text-white">${fmt(r.usage)}</div></div>
                      </div>
                    </div>`;
                  }).join('')}
                </div>
              </div>
            `).join('')}
          </div>

          <div class="fixed bottom-0 left-0 w-full p-4 bg-white/80 backdrop-blur-md border-t flex gap-3">
             <button onclick="app.placeholderAction('PDF Report')" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/><path d="M4.603 12.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.487-.645 19.787 19.787 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.192.12.54.1.967-.028.573-.165 1.187-.477 1.765a11.276 11.276 0 0 0 1.13 2.022c.616.289 1.148.52 1.547.747.587.331.85.64.843.937a.494.494 0 0 1-.18.372.409.409 0 0 1-.33.107c-.28-.05-.627-.257-1.067-.606a11.498 11.498 0 0 1-1.074-1.015 12.15 12.15 0 0 1-1.187.423 10.339 10.339 0 0 1-2.328.444c-.496.688-.982 1.188-1.49 1.322a.417.417 0 0 1-.312-.035zm2.802-5.903c.181.583.209 1.128.158 1.56a11.57 11.57 0 0 1-.12-.845c-.032-.35-.02-.69.043-.96.038-.164.1-.304.161-.355.059-.047.12-.05.151-.015a.33.33 0 0 1 .012.054c.006.021.02.059.015.066z"/></svg>
                Download PDF
             </button>
             <button onclick="app.placeholderAction('Official Logsheet Print')" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/></svg>
                Print Logsheet
             </button>
          </div>
        </div>`;
      }
      
      editFromReview(i) { 
        this.state.isSingleEdit = false;
        this.state.currentIndex = i; 
        this.state.view = 'reading'; 
        this.render(); 
      }

      editFromDashboard(id) {
        const pin = prompt("Enter Admin PIN to edit records:");
        if (pin === "abnpower") {
          const index = MOCK_EQUIPMENT.findIndex(e => e.id === id);
          if (index !== -1) { 
            this.state.isSingleEdit = true;
            this.state.currentIndex = index; 
            this.state.view = 'reading'; 
            this.render(); 
          }
        } else if (pin !== null) {
          alert("‚ùå Incorrect PIN. Access Denied.");
        }
      }
    }
    const app = new PowerCon();
  </script>
</body>
</html>
