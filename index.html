<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>POWERCON</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    .font-mono-numbers { font-family: ui-monospace, monospace; font-variant-numeric: tabular-nums; }
    body { 
      background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('./assets/bg.jpg');
      background-size: cover; background-position: center; background-attachment: fixed;
    }
    input[type="date"] { display: block; -webkit-appearance: none; min-height: 4rem; width: 100%; }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 0.75rem; }
    .modal-content { background: white; border-radius: 2rem; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .btn-touch:active { transform: scale(0.96); opacity: 0.9; }
  </style>
</head>
<body class="h-full text-slate-900 overflow-x-hidden">
  <div id="app" class="h-full w-full"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCwtWs9YdZMojl1FwQNXbAF-QRhWCrlWMQ",
      authDomain: "powercon-nutriveb.firebaseapp.com",
      projectId: "powercon-nutriveb",
      storageBucket: "powercon-nutriveb.firebasestorage.app",
      messagingSenderId: "780606101460",
      appId: "1:780606101460:web:ce9b6c7b73bb756a5a6841",
      databaseURL: "https://powercon-nutriveb-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MOCK_EQUIPMENT = [
      { id: '1', name: 'Refrigeration System', loc: 'UTILITIES' }, { id: '2', name: 'Clean Steam Generator', loc: 'UTILITIES' }, { id: '3', name: 'Bulk Chemical System', loc: 'UTILITIES' }, { id: '4', name: 'Condensate Return System', loc: 'UTILITIES' }, { id: '5', name: 'RVAC', loc: 'UTILITIES' }, { id: '6', name: 'BOILER', loc: 'UTILITIES' }, { id: '7', name: 'Compressed Dry Air (CDA)', loc: 'UTILITIES' }, { id: '8', name: 'Waste Water Treatment Plant (WWTP)', loc: 'UTILITIES' }, { id: '9', name: 'Water Treatment Plant (WTP)', loc: 'UTILITIES' }, { id: '10', name: 'Combined Water Storage (CWS)', loc: 'UTILITIES' }, { id: '11', name: 'Sump Pit Pump 1', loc: 'UTILITIES' }, { id: '12', name: 'Freezer & Cold Storage', loc: 'UTILITIES' }, { id: '13', name: 'CIP Line (E7)', loc: 'PROCESS' }, { id: '14', name: 'Bottle Washer (E8)', loc: 'PROCESS' }, { id: '15', name: 'Modular Labeller (E9)', loc: 'PROCESS' }, { id: '16', name: 'Container Conveyor (E10)', loc: 'PROCESS' }, { id: '17', name: 'Conveyor Lubrication (E11)', loc: 'PROCESS' }, { id: '18', name: 'Alwin Soy', loc: 'PROCESS' }, { id: '19', name: 'Process MCC', loc: 'PROCESS' }, { id: '20', name: 'Homogenizer', loc: 'PROCESS' }, { id: '21', name: 'Soya Bean Pre-treatment & Handling', loc: 'PROCESS' }, { id: '22', name: 'Sugar Dissolving', loc: 'PROCESS' }, { id: '23', name: 'Container Dryer (E1)', loc: 'BOTTLING' }, { id: '24', name: 'Packer (E2)', loc: 'BOTTLING' }, { id: '25', name: 'Unpacker (E3)', loc: 'BOTTLING' }, { id: '26', name: 'Container Depalettiser (E4)', loc: 'BOTTLING' }, { id: '27', name: 'Pack Washing (E5)', loc: 'BOTTLING' }, { id: '28', name: 'Inspector (E6)', loc: 'BOTTLING' }, { id: '29', name: 'Pack Conveyor (E12)', loc: 'BOTTLING' }, { id: '30', name: 'Ups', loc: 'BOTTLING' }, { id: '31', name: 'Wrap Round', loc: 'BOTTLING' }, { id: '32', name: 'Hydro Sterilizer', loc: 'BOTTLING' }, { id: '33', name: 'Filler', loc: 'BOTTLING' }, { id: '34', name: 'DPP', loc: 'LVSG 5 LOADS' }, { id: '35', name: 'DLP', loc: 'LVSG 5 LOADS' }, { id: '36', name: 'WareHouse', loc: 'LVSG 5 LOADS' }, { id: '37', name: 'RVAC (220V)', loc: 'LVSG 5 LOADS' }, { id: '38', name: 'WWTP (220V)', loc: 'LVSG 5 LOADS' }, { id: '39', name: 'DP-WM', loc: 'LVSG 5 LOADS' }, { id: '40', name: 'Sumppit Pump2', loc: 'LVSG 5 LOADS' }, { id: '41', name: 'Accumulation Table', loc: 'LVSG 5 LOADS' }
    ];

    const fmt = (num) => (num || 0).toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 });

    class PowerCon {
      constructor() {
        this.state = {
          view: 'home', currentIndex: 0,
          date: new Date().toISOString().split('T')[0],
          filterDate: new Date().toISOString().split('T')[0],
          sessionReadings: [],
          cloudReadings: {},
          yesterdayReadings: {}, // Placeholder para sa data kahapon
          loading: false
        };
        this.init();
      }

      async init() { this.render(); await this.syncWithCloud(); }

      async syncWithCloud() {
        this.state.loading = true; this.render();
        
        // 1. Kunin ang data para sa piniling date (Today)
        const snapshot = await db.ref('readings/' + this.state.filterDate).once('value');
        this.state.cloudReadings = snapshot.val() || {};

        // 2. MAGIC FIX: Kunin ang data ng KAHAPON (Previous)
        const d = new Date(this.state.date);
        d.setDate(d.getDate() - 1);
        const yKey = d.toISOString().split('T')[0];
        const ySnap = await db.ref('readings/' + yKey).once('value');
        this.state.yesterdayReadings = ySnap.val() || {};

        // 3. I-resume ang session kung meron na
        if(this.state.filterDate === this.state.date) {
            MOCK_EQUIPMENT.forEach((eq, i) => {
                if(this.state.cloudReadings[eq.id]) this.state.sessionReadings[i] = this.state.cloudReadings[eq.id];
            });
        }
        
        this.state.loading = false; this.render();
      }

      start() { this.state.view = 'reading'; this.state.currentIndex = 0; this.render(); }

      async saveReading(curr, prevInput) {
        const eq = MOCK_EQUIPMENT[this.state.currentIndex];
        const current = parseFloat(parseFloat(curr).toFixed(3));
        
        let prev = 0;
        if (prevInput) {
          prev = parseFloat(parseFloat(prevInput).toFixed(3));
        } else {
          // Kunin mula sa "yesterdayReadings" na niload natin sa syncWithCloud
          const yData = this.state.yesterdayReadings ? this.state.yesterdayReadings[eq.id] : null;
          prev = yData ? parseFloat(yData.curr.toFixed(3)) : 0;
        }

        const usage = parseFloat((current - prev).toFixed(3));
        if (current < prev && !confirm("⚠️ ABNORMAL: Current is lower than Previous. Continue?")) return;
        
        this.state.sessionReadings[this.state.currentIndex] = {
          id: eq.id, name: eq.name, loc: eq.loc, curr: current, prev: prev, usage: usage
        };

        if (this.state.currentIndex < 40) { this.state.currentIndex++; this.render(); } 
        else { this.state.view = 'review'; this.render(); }
      }

      async finalCloudSave() {
        this.state.loading = true; this.render();
        const updates = {};
        this.state.sessionReadings.forEach(r => { if(r) updates[`/readings/${this.state.date}/${r.id}`] = r; });
        try {
          await db.ref().update(updates);
          alert("✅ Records Synced with Cloud!");
          this.state.filterDate = this.state.date;
          this.state.view = 'records';
          await this.syncWithCloud();
        } catch (e) { alert("Sync Error: " + e.message); }
        this.state.loading = false; this.render();
      }

      render() { document.getElementById('app').innerHTML = this[`${this.state.view}HTML`](); }

      homeHTML() {
        return `<div class="p-6 max-w-sm mx-auto flex flex-col justify-center min-h-screen text-center">
          <h1 class="text-6xl font-black text-slate-900 italic tracking-tighter mb-2">POWER<span class="text-blue-600">CON</span></h1>
          <p class="text-slate-400 font-bold text-[10px] tracking-[0.4em] mb-12 uppercase italic text-blue-500">Calculator</p>
          <div class="flex flex-col gap-4 w-full">
            <div class="w-full">
               <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block text-center tracking-widest">Select Reading Date</label>
               <input type="date" id="mainDate" value="${this.state.date}" class="w-full px-5 py-4 bg-white rounded-3xl border-2 border-slate-100 shadow-sm font-bold text-lg outline-none text-center" onchange="app.state.date=this.value; app.syncWithCloud()">
            </div>
            <button onclick="app.start()" class="btn-touch w-full bg-blue-600 text-white font-black py-6 rounded-3xl shadow-xl text-xl uppercase italic">Start / Resume</button>
            <button onclick="app.state.view='records';app.render()" class="btn-touch w-full bg-slate-900 text-white font-bold py-5 rounded-3xl uppercase tracking-widest text-sm">View Dashboard</button>
          </div>
          ${this.state.loading ? '<p class="mt-4 text-[10px] font-bold animate-pulse text-blue-600 uppercase">Fetching Cloud Data...</p>' : ''}
        </div>`;
      }

      readingHTML() {
        const eq = MOCK_EQUIPMENT[this.state.currentIndex];
        const existing = this.state.sessionReadings[this.state.currentIndex];
        
        // Default value para sa Previous field (auto-fetch)
        let autoPrev = '';
        if (existing) {
          autoPrev = existing.prev;
        } else {
          const yData = this.state.yesterdayReadings ? this.state.yesterdayReadings[eq.id] : null;
          autoPrev = yData ? yData.curr : '0.000';
        }

        return `<div class="modal"><div class="modal-content p-8 shadow-2xl">
          <div class="flex justify-between items-center mb-6"><span class="text-[10px] font-black bg-blue-600 text-white px-3 py-1 rounded-full uppercase">${eq.loc}</span><span class="text-xs font-bold text-slate-300">${this.state.currentIndex+1}/41</span></div>
          <h2 class="text-2xl font-black leading-tight mb-8">${eq.name}</h2>
          <form onsubmit="event.preventDefault(); app.saveReading(document.getElementById('c').value, document.getElementById('p').value)">
            <div class="mb-4 p-4 bg-slate-50 rounded-2xl border text-left">
              <label class="text-[8px] font-black text-slate-400 uppercase tracking-widest italic text-blue-500">Previous Reading (Verified)</label>
              <input type="number" id="p" step="0.001" class="w-full bg-transparent text-xl font-bold outline-none text-slate-400" value="${autoPrev}" placeholder="0.000">
            </div>
            <div class="mb-10 text-left">
              <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest text-center">Enter Current Reading</label>
              <input type="number" id="c" step="0.001" class="w-full p-6 bg-slate-100 rounded-3xl text-4xl font-black outline-none font-mono-numbers shadow-inner text-center text-blue-600" value="${existing ? existing.curr : ''}" required autofocus>
            </div>
            <div class="grid grid-cols-2 gap-4"><button type="button" onclick="app.state.view='home';app.render()" class="py-5 font-bold text-slate-400 uppercase text-xs">Exit</button><button type="submit" class="bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl uppercase tracking-tighter">Save & Next</button></div>
          </form>
        </div></div>`;
      }

      reviewHTML() {
        return `<div class="p-6 max-w-2xl mx-auto flex flex-col min-h-screen">
          <h2 class="text-4xl font-black mb-2 italic pt-10 uppercase">Review</h2>
          <p class="text-[10px] text-slate-400 font-bold mb-6 tracking-widest">TAP ANY ITEM TO EDIT BEFORE SYNCING</p>
          <div class="bg-white rounded-[2.5rem] shadow-xl border overflow-hidden flex-1 mb-6 overflow-y-auto">
             <table class="w-full text-xs">
               <tbody class="divide-y divide-slate-100">
                 ${this.state.sessionReadings.map((r, i) => r ? `
                   <tr onclick="app.editFromReview(${i})" class="active:bg-blue-50">
                     <td class="p-4 font-black text-slate-800 uppercase text-[9px] leading-tight">${r.name}</td>
                     <td class="p-4 text-right font-mono-numbers font-black text-blue-600">${fmt(r.curr)}</td>
                   </tr>` : '').join('')}
               </tbody>
             </table>
          </div>
          <button onclick="app.finalCloudSave()" class="btn-touch w-full bg-green-600 text-white font-black py-7 rounded-3xl shadow-2xl text-xl uppercase italic mb-10">Push to Cloud ✓</button>
        </div>`;
      }

      recordsHTML() {
        const cats = ["UTILITIES", "PROCESS", "BOTTLING", "LVSG 5 LOADS"];
        const data = Object.values(this.state.cloudReadings);
        const total = data.reduce((s, r) => s + (r.usage || 0), 0);
        return `<div class="p-4 max-w-2xl mx-auto min-h-screen pb-24">
          <div class="flex justify-between items-center mb-4 pt-4">
            <button onclick="app.state.view='home';app.render()" class="font-black text-slate-400 text-xs tracking-widest">← HOME</button>
            <input type="date" value="${this.state.filterDate}" onchange="app.state.filterDate=this.value; app.syncWithCloud()" class="bg-white px-3 py-1 rounded-xl border-2 border-blue-100 font-bold text-xs shadow-sm text-center">
          </div>
          <div class="bg-white/90 backdrop-blur p-6 rounded-[2rem] shadow-xl border border-white mb-6 text-center">
            <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 italic">Total Plant Load (kWh)</h3>
            <div class="text-4xl font-black text-slate-900 font-mono-numbers">${fmt(total)}</div>
          </div>
          <div class="space-y-6">
            ${cats.map(cat => `
              <div>
                <div class="px-4 mb-2 text-[10px] font-black text-slate-500 uppercase tracking-widest">${cat}</div>
                <div class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-200 overflow-hidden divide-y">
                  ${MOCK_EQUIPMENT.filter(e => e.loc === cat).map(e => {
                    const r = this.state.cloudReadings[e.id] || { prev: 0, curr: 0, usage: 0 };
                    return `
                    <div class="p-5 active:bg-blue-50" onclick="app.editFromDashboard('${e.id}')">
                      <div class="text-[11px] font-black text-slate-800 uppercase mb-3 flex justify-between">${e.name} <span class="text-[8px] text-blue-400">Edit ✎</span></div>
                      <div class="grid grid-cols-3 gap-2">
                        <div class="text-center bg-white border p-2 rounded-xl"><div class="text-[7px] font-bold text-slate-400 uppercase">Prev</div><div class="text-[12px] font-mono-numbers">${fmt(r.prev)}</div></div>
                        <div class="text-center bg-white border p-2 rounded-xl"><div class="text-[7px] font-bold text-blue-500 italic uppercase font-black">Curr</div><div class="text-[12px] font-mono-numbers font-black">${fmt(r.curr)}</div></div>
                        <div class="text-center bg-blue-600 p-2 rounded-xl"><div class="text-[7px] font-black text-blue-100 uppercase">Usage</div><div class="text-[12px] font-mono-numbers font-black text-white">${fmt(r.usage)}</div></div>
                      </div>
                    </div>`;
                  }).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        </div>`;
      }
      
      editFromReview(i) { this.state.currentIndex = i; this.state.view = 'reading'; this.render(); }
      editFromDashboard(id) {
        const index = MOCK_EQUIPMENT.findIndex(e => e.id === id);
        if (index !== -1) { this.state.currentIndex = index; this.state.view = 'reading'; this.render(); }
      }
    }
    const app = new PowerCon();
  </script>
</body>
</html>
