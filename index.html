<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>POWERCON Cloud - Nutribeu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <style>
    .font-mono-numbers { font-family: ui-monospace, monospace; font-variant-numeric: tabular-nums; }
    
    /* Background Image Setup */
    body { 
      background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('./assets/bg.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 0.75rem; }
    .modal-content { background: white; border-radius: 2rem; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .btn-touch:active { transform: scale(0.96); opacity: 0.9; }
    
    /* Mobile Input Fix */
    input[type="date"], input[type="number"] { -webkit-appearance: none; min-height: 3.5rem; }
  </style>
</head>
<body class="h-full text-slate-900 overflow-x-hidden">
  <div id="app" class="h-full w-full"></div>

  <script>
    // --- YOUR FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyCwtWs9YdZMojl1FwQNXbAF-QRhWCrlWMQ",
      authDomain: "powercon-nutriveb.firebaseapp.com",
      projectId: "powercon-nutriveb",
      storageBucket: "powercon-nutriveb.firebasestorage.app",
      messagingSenderId: "780606101460",
      appId: "1:780606101460:web:ce9b6c7b73bb756a5a6841",
      databaseURL: "https://powercon-nutriveb-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MOCK_EQUIPMENT = [
      { id: '1', name: 'Refrigeration System', loc: 'UTILITIES' }, { id: '2', name: 'Clean Steam Generator', loc: 'UTILITIES' }, { id: '3', name: 'Bulk Chemical System', loc: 'UTILITIES' }, { id: '4', name: 'Condensate Return System', loc: 'UTILITIES' }, { id: '5', name: 'RVAC', loc: 'UTILITIES' }, { id: '6', name: 'BOILER', loc: 'UTILITIES' }, { id: '7', name: 'Compressed Dry Air (CDA)', loc: 'UTILITIES' }, { id: '8', name: 'Waste Water Treatment Plant (WWTP)', loc: 'UTILITIES' }, { id: '9', name: 'Water Treatment Plant (WTP)', loc: 'UTILITIES' }, { id: '10', name: 'Combined Water Storage (CWS)', loc: 'UTILITIES' }, { id: '11', name: 'Sump Pit Pump 1', loc: 'UTILITIES' }, { id: '12', name: 'Freezer & Cold Storage', loc: 'UTILITIES' }, { id: '13', name: 'CIP Line (E7)', loc: 'PROCESS' }, { id: '14', name: 'Bottle Washer (E8)', loc: 'PROCESS' }, { id: '15', name: 'Modular Labeller (E9)', loc: 'PROCESS' }, { id: '16', name: 'Container Conveyor (E10)', loc: 'PROCESS' }, { id: '17', name: 'Conveyor Lubrication (E11)', loc: 'PROCESS' }, { id: '18', name: 'Alwin Soy', loc: 'PROCESS' }, { id: '19', name: 'Process MCC', loc: 'PROCESS' }, { id: '20', name: 'Homogenizer', loc: 'PROCESS' }, { id: '21', name: 'Soya Bean Pre-treatment & Handling', loc: 'PROCESS' }, { id: '22', name: 'Sugar Dissolving', loc: 'PROCESS' }, { id: '23', name: 'Container Dryer (E1)', loc: 'BOTTLING' }, { id: '24', name: 'Packer (E2)', loc: 'BOTTLING' }, { id: '25', name: 'Unpacker (E3)', loc: 'BOTTLING' }, { id: '26', name: 'Container Depalettiser (E4)', loc: 'BOTTLING' }, { id: '27', name: 'Pack Washing (E5)', loc: 'BOTTLING' }, { id: '28', name: 'Inspector (E6)', loc: 'BOTTLING' }, { id: '29', name: 'Pack Conveyor (E12)', loc: 'BOTTLING' }, { id: '30', name: 'Ups', loc: 'BOTTLING' }, { id: '31', name: 'Wrap Round', loc: 'BOTTLING' }, { id: '32', name: 'Hydro Sterilizer', loc: 'BOTTLING' }, { id: '33', name: 'Filler', loc: 'BOTTLING' }, { id: '34', name: 'DPP', loc: 'LVSG 5 LOADS' }, { id: '35', name: 'DLP', loc: 'LVSG 5 LOADS' }, { id: '36', name: 'WareHouse', loc: 'LVSG 5 LOADS' }, { id: '37', name: 'RVAC (220V)', loc: 'LVSG 5 LOADS' }, { id: '38', name: 'WWTP (220V)', loc: 'LVSG 5 LOADS' }, { id: '39', name: 'DP-WM', loc: 'LVSG 5 LOADS' }, { id: '40', name: 'Sumppit Pump2', loc: 'LVSG 5 LOADS' }, { id: '41', name: 'Accumulation Table', loc: 'LVSG 5 LOADS' }
    ];

    class PowerCon {
      constructor() {
        this.state = {
          view: 'home', currentIndex: 0, 
          date: new Date().toISOString().split('T')[0],
          filterDate: new Date().toISOString().split('T')[0],
          sessionReadings: [],
          cloudReadings: {},
          loading: false
        };
        this.init();
      }

      async init() {
        this.render();
        await this.syncWithCloud();
      }

      async syncWithCloud() {
        this.state.loading = true; this.render();
        const snapshot = await db.ref('readings/' + this.state.filterDate).once('value');
        this.state.cloudReadings = snapshot.val() || {};
        this.state.loading = false; this.render();
      }

      start() {
        this.state.sessionReadings = [];
        this.state.currentIndex = 0;
        this.state.view = 'reading';
        this.render();
      }

      async saveReading(curr, prevInput) {
        const eq = MOCK_EQUIPMENT[this.state.currentIndex];
        const current = parseFloat(curr);
        
        // Auto-fetch yesterday's data as default if no input
        let prev = prevInput ? parseFloat(prevInput) : 0;
        if (!prevInput) {
          const yesterday = new Date(this.state.date);
          yesterday.setDate(yesterday.getDate() - 1);
          const yKey = yesterday.toISOString().split('T')[0];
          const ySnap = await db.ref(`readings/${yKey}/${eq.id}`).once('value');
          prev = ySnap.exists() ? ySnap.val().curr : 0;
        }

        if (current < prev && !confirm("⚠️ ABNORMAL: Current is lower than Previous. Continue?")) return;

        this.state.sessionReadings[this.state.currentIndex] = {
          id: eq.id, name: eq.name, loc: eq.loc, curr: current, prev: prev, usage: current - prev
        };

        if (this.state.currentIndex < 40) {
          this.state.currentIndex++;
          this.render();
        } else {
          this.state.view = 'review';
          this.render();
        }
      }

      async finalCloudSave() {
        this.state.loading = true; this.render();
        const updates = {};
        this.state.sessionReadings.forEach(r => {
          updates[`/readings/${this.state.date}/${r.id}`] = r;
        });
        try {
          await db.ref().update(updates);
          alert("✅ Shared to Cloud Successfully!");
          this.state.filterDate = this.state.date;
          this.state.view = 'records';
          await this.syncWithCloud();
        } catch (e) { alert("Error: " + e.message); }
        this.state.loading = false; this.render();
      }

      render() { document.getElementById('app').innerHTML = this[`${this.state.view}HTML`](); }

      homeHTML() {
        return `<div class="p-6 max-w-sm mx-auto flex flex-col justify-center min-h-screen text-center">
          <h1 class="text-6xl font-black text-slate-900 italic tracking-tighter mb-2">POWER<span class="text-blue-600">CON</span></h1>
          <p class="text-slate-400 font-bold text-[10px] tracking-[0.4em] mb-12 uppercase italic">CALCULATOR APP</p>
          
          <div class="space-y-4 w-full px-2">
            <div class="w-full">
               <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block text-left ml-4">Select Reading Date</label>
               <input type="date" value="${this.state.date}" class="w-full p-5 bg-white rounded-3xl border-2 border-slate-100 shadow-sm font-bold text-lg outline-none mb-2" onchange="app.state.date=this.value">
            </div>
            <button onclick="app.start()" class="btn-touch w-full bg-blue-600 text-white font-black py-6 rounded-3xl shadow-xl text-xl uppercase italic">Start Reading</button>
            <button onclick="app.state.view='records';app.render()" class="btn-touch w-full bg-slate-900 text-white font-bold py-5 rounded-3xl uppercase tracking-widest text-sm">View LOGSHEET</button>
          </div>
          ${this.state.loading ? '<p class="mt-6 text-blue-500 font-bold animate-pulse text-xs">Connecting to Singapore Server...</p>' : ''}
        </div>`;
      }

      readingHTML() {
        const eq = MOCK_EQUIPMENT[this.state.currentIndex];
        return `<div class="modal"><div class="modal-content p-8 shadow-2xl">
          <div class="flex justify-between items-center mb-6"><span class="text-[10px] font-black bg-blue-600 text-white px-3 py-1 rounded-full uppercase">${eq.loc}</span><span class="text-xs font-bold text-slate-300">${this.state.currentIndex+1}/41</span></div>
          <h2 class="text-2xl font-black leading-tight mb-8">${eq.name}</h2>
          <form onsubmit="event.preventDefault(); app.saveReading(document.getElementById('c').value, document.getElementById('p').value)">
            <div class="mb-4 p-4 bg-slate-50 rounded-2xl border">
              <label class="text-[8px] font-black text-slate-400 uppercase">Manual Previous Override (Optional)</label>
              <input type="number" id="p" step="0.01" class="w-full bg-transparent text-xl font-bold outline-none" placeholder="Leave blank to use history">
            </div>
            <div class="mb-10">
              <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block font-bold">Current Reading</label>
              <input type="number" id="c" step="0.01" class="w-full p-6 bg-slate-100 rounded-3xl text-4xl font-black outline-none font-mono-numbers shadow-inner" required autofocus>
            </div>
            <div class="grid grid-cols-2 gap-4"><button type="button" onclick="app.state.view='home';app.render()" class="py-5 font-bold text-slate-400 uppercase text-xs">Exit</button><button type="submit" class="bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl uppercase">Next →</button></div>
          </form>
        </div></div>`;
      }

      reviewHTML() {
        return `<div class="p-6 max-w-2xl mx-auto flex flex-col min-h-screen">
          <h2 class="text-4xl font-black mb-2 italic pt-10">Review</h2>
          <p class="text-[10px] font-bold text-slate-400 uppercase mb-6 tracking-widest">Verify all 41 equipments</p>
          <div class="bg-white rounded-[2.5rem] shadow-xl border overflow-hidden flex-1 mb-6 overflow-y-auto">
             <table class="w-full text-xs">
               <tbody class="divide-y divide-slate-100">
                 ${this.state.sessionReadings.map((r, i) => `
                   <tr onclick="app.state.currentIndex=${i}; app.state.view='reading'; app.render()" class="active:bg-blue-50">
                     <td class="p-4">
                       <div class="font-black text-slate-800 uppercase text-[10px]">${r.name}</div>
                       <div class="text-lg font-mono-numbers font-black ${r.curr < r.prev ? 'text-red-500' : 'text-blue-600'}">${r.curr.toLocaleString()}</div>
                     </td>
                     <td class="p-4 text-right">
                        <div class="text-[8px] font-bold text-slate-300">USAGE</div>
                        <div class="font-mono-numbers font-bold">${r.usage.toLocaleString()}</div>
                     </td>
                   </tr>`).join('')}
               </tbody>
             </table>
          </div>
          <button onclick="app.finalCloudSave()" class="btn-touch w-full bg-green-600 text-white font-black py-7 rounded-3xl shadow-2xl text-xl uppercase italic mb-10">
            ${this.state.loading ? 'Syncing...' : 'Confirm & Sync to Cloud ✓'}
          </button>
        </div>`;
      }

      recordsHTML() {
        const cats = ["UTILITIES", "PROCESS", "BOTTLING", "LVSG 5 LOADS"];
        const data = Object.values(this.state.cloudReadings);
        const total = data.reduce((s, r) => s + (r.usage || 0), 0);

        return `<div class="p-4 max-w-2xl mx-auto min-h-screen pb-24">
          <div class="flex justify-between items-center mb-4 pt-4">
            <button onclick="app.state.view='home';app.render()" class="font-black text-slate-400 text-xs tracking-widest">← HOME</button>
            <input type="date" value="${this.state.filterDate}" onchange="app.state.filterDate=this.value; app.syncWithCloud()" class="bg-white px-3 py-1 rounded-xl border-2 border-blue-100 font-bold text-xs shadow-sm">
          </div>
          
          <div class="bg-white/80 backdrop-blur p-6 rounded-[2rem] shadow-xl border border-white mb-6 text-center">
            <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Live Plant Usage</h3>
            <div class="text-4xl font-black text-slate-900 font-mono-numbers">${total.toLocaleString()} <span class="text-sm text-slate-300 italic">kWh</span></div>
          </div>

          <div class="space-y-6">
            ${cats.map(cat => `
              <div>
                <div class="px-4 mb-2 text-[10px] font-black text-slate-500 uppercase tracking-widest">${cat}</div>
                <div class="bg-white/90 backdrop-blur rounded-3xl shadow-sm border border-slate-200 overflow-hidden divide-y">
                  ${MOCK_EQUIPMENT.filter(e => e.loc === cat).map(e => {
                    const r = this.state.cloudReadings[e.id] || { prev: 0, curr: 0, usage: 0 };
                    return `
                    <div class="p-5 active:bg-blue-50">
                      <div class="text-[11px] font-black text-slate-800 uppercase mb-3 flex justify-between">${e.name} ${r.curr > 0 && r.curr < r.prev ? '<span class="text-red-500 italic">! ABNORMAL</span>' : ''}</div>
                      <div class="grid grid-cols-3 gap-2">
                        <div class="text-center bg-white border p-2 rounded-xl"><div class="text-[7px] font-bold text-slate-400">Previous</div><div class="text-[12px] font-mono-numbers">${r.prev.toLocaleString()}</div></div>
                        <div class="text-center bg-white border p-2 rounded-xl"><div class="text-[7px] font-bold text-slate-400">Current</div><div class="text-[12px] font-mono-numbers font-black">${r.curr > 0 ? r.curr.toLocaleString() : '---'}</div></div>
                        <div class="text-center bg-blue-600 p-2 rounded-xl"><div class="text-[7px] font-black text-blue-100">TOTAL kWh</div><div class="text-[12px] font-mono-numbers font-black text-white">${r.usage.toLocaleString()}</div></div>
                      </div>
                    </div>`;
                  }).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        </div>`;
      }
    }
    const app = new PowerCon();
  </script>
</body>
</html>
